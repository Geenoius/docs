(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{201:function(t,s,a){"use strict";a.r(s);var e=a(4),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"sqlserver"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sqlserver"}},[t._v("#")]),t._v(" sqlserver")]),t._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),a("p",[t._v("整理常用的 Sql 语法使用。")])]),t._v(" "),a("h2",{attrs:{id:"upate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#upate"}},[t._v("#")]),t._v(" Upate")]),t._v(" "),a("p",[t._v("1.根据"),a("code",[t._v("表关联")]),t._v("的查询结果进行批量更新数据")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BillOfMaterials\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" PerAssemblyQty "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PerAssemblyQty "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BillOfMaterials "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" c\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" Parts "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" d "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProductAssemblyID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AssemblyID\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("2.根据"),a("code",[t._v("with cte")]),t._v("的查询结果进行批量更新数据")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("USE")]),t._v(" AdventureWorks2012"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nGO\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WITH")]),t._v(" Parts"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("AssemblyID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ComponentID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PerAssemblyQty"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EndDate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ComponentLevel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProductAssemblyID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PerAssemblyQty"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EndDate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ComponentLevel\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BillOfMaterials "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" b\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProductAssemblyID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("800")]),t._v("\n          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EndDate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("IS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UNION")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ALL")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" bom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProductAssemblyID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" bom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentID"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PerAssemblyQty"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        bom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EndDate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ComponentLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BillOfMaterials "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" bom\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INNER")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" Parts "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" p\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" bom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProductAssemblyID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" p"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentID\n        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" bom"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("EndDate "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("IS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--关联其他表进行数据更新")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BillOfMaterials\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" PerAssemblyQty "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PerAssemblyQty "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BillOfMaterials "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" c\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("JOIN")]),t._v(" Parts "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" d "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),t._v(" c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ProductAssemblyID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AssemblyID\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ComponentLevel "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("h2",{attrs:{id:"try-catch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#try-catch"}},[t._v("#")]),t._v(" Try-Catch")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/sql/t-sql/language-elements/try-catch-transact-sql?view=sql-server-ver15",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考链接"),a("OutboundLink")],1)])]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Check to see whether this stored procedure exists.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" OBJECT_ID "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("N"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'usp_GetErrorInfo'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" N"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'P'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("IS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("NOT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("NULL")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DROP")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PROCEDURE")]),t._v(" usp_GetErrorInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nGO\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Create procedure to retrieve error information.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PROCEDURE")]),t._v(" usp_GetErrorInfo\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v("\n         ERROR_NUMBER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ErrorNumber\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("ERROR_SEVERITY"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ErrorSeverity\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("ERROR_STATE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ErrorState\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("ERROR_LINE "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ErrorLine\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("ERROR_PROCEDURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ErrorProcedure\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("ERROR_MESSAGE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v(" ErrorMessage"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nGO\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- SET XACT_ABORT ON will cause the transaction to be uncommittable")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- when the constraint violation occurs.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SET")]),t._v(" XACT_ABORT "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ON")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v(" TRY\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TRANSACTION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- A FOREIGN KEY constraint exists on this table. This")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- statement will generate a constraint violation error.")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DELETE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" Production"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Product\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" ProductID "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("980")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- If the DELETE statement succeeds, commit the transaction.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMIT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TRANSACTION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),t._v(" TRY\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v(" CATCH\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Execute error retrieval routine.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXECUTE")]),t._v(" usp_GetErrorInfo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Test XACT_STATE:")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- If 1, the transaction is committable.")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- If -1, the transaction is uncommittable and should")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--     be rolled back.")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- XACT_STATE = 0 means that there is no transaction and")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("--     a commit or rollback operation would generate an error.")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Test whether the transaction is uncommittable.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("XACT_STATE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRINT")]),t._v("\n            N"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'The transaction is in an uncommittable state.'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Rolling back transaction.'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ROLLBACK")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TRANSACTION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- Test whether the transaction is committable.")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("XACT_STATE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BEGIN")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRINT")]),t._v("\n            N"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'The transaction is committable.'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n            "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Committing transaction.'")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COMMIT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TRANSACTION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("END")]),t._v(" CATCH"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nGO\n")])])]),a("h2",{attrs:{id:"使用程序集"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用程序集"}},[t._v("#")]),t._v(" 使用程序集")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/clr-integration/database-objects/getting-started-with-clr-integration?view=sql-server-2017",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考链接"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("1."),a("code",[t._v("所需命名空间")])]),t._v(" "),a("p",[t._v("开发基本 CLR 数据库对象所需的组件随一起安装 SQL Server 。 CLR 集成功能在称作 system.data.dll 的程序集中公开，该程序集是 .NET Framework 的一部分。 该程序集还在全局程序集缓存 (GAC) 以及 .NET Framework 目录中提供。 对此程序集的引用通常由命令行工具和 Microsoft Visual Studio 自动添加，因此无需手动添加它。")]),t._v(" "),a("p",[t._v("system.data.dll 程序集包含以下命名空间，这些命名空间是编译 CLR 数据库对象所必需的：")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("System.Data")])]),t._v(" "),a("li",[a("code",[t._v("System.Data.Sql")])]),t._v(" "),a("li",[a("code",[t._v("Microsoft.SqlServer.Server")])]),t._v(" "),a("li",[a("code",[t._v("System.Data.SqlTypes")])])]),t._v(" "),a("p",[t._v("提示")]),t._v(" "),a("p",[t._v("支持在 Linux 上加载 CLR 数据库对象，但必须用 .NET Framework 生成它们（SQL Server CLR 集成不支持 .NET Core）。 此外，Linux 不支持具有 EXTERNAL_ACCESS 或 UNSAFE 权限集的 CLR 程序集。")]),t._v(" "),a("p",[t._v("2."),a("code",[t._v("撰写一个简单的“Hello World”存储过程")])]),t._v(" "),a("p",[t._v("将以下 Visual C# 或 Microsoft Visual Basic 代码复制并粘贴到某一文本编辑器中，并且将其保存在名为“helloworld.cs”或“helloworld.vb”的文件中。")]),t._v(" "),a("p",[t._v("C#复制")]),t._v(" "),a("div",{staticClass:"language-csharp extra-class"},[a("pre",{pre:!0,attrs:{class:"language-csharp"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("Microsoft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SqlServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("using")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token namespace"}},[t._v("System"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SqlTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("HelloWorldProc")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token attribute"}},[a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Microsoft"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SqlServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SqlProcedure")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("static")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token return-type class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("HelloWorld")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("out")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("string")])]),t._v(" text"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        SqlContext"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Pipe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Send")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello world!"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" Environment"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("NewLine"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        text "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Hello world!"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("这一简单的程序包含针对公共类的单个静态方法。 此方法使用两个新类**"),a("a",{attrs:{href:"https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlcontext.aspx",target:"_blank",rel:"noopener noreferrer"}},[t._v("SqlContext"),a("OutboundLink")],1),t._v("** 和**"),a("a",{attrs:{href:"https://msdn.microsoft.com/library/microsoft.sqlserver.server.sqlpipe.aspx",target:"_blank",rel:"noopener noreferrer"}},[t._v("SqlPipe"),a("OutboundLink")],1),t._v("**，创建托管数据库对象以输出简单的短信。 此方法还将字符串“Hello world!”指派 为某一输出参数的值。 此方法可以声明为 SQL Server 中的存储过程，然后采用与 Transact-SQL 存储过程相同的方式运行。")]),t._v(" "),a("p",[t._v("将此程序编译为库，将其加载到 SQL Server 中，并将其作为存储过程运行。")]),t._v(" "),a("p",[t._v("3."),a("code",[t._v('编译 "Hello World" 存储过程')])]),t._v(" "),a("p",[t._v("SQL Server 默认情况下将安装 Microsoft .NET Framework 再分发文件。 这些文件包括 csc.exe 和 vbc.exe，它们是用于 Visual C# 和 Visual Basic 程序的命令行编译器。 为了编译我们的示例，您必须修改路径变量以指向包含 csc.exe 或 vbc.exe 的目录。 下面是 .NET Framework 的默认安装路径。")]),t._v(" "),a("div",{staticClass:"language-txt extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("C:\\Windows\\Microsoft.NET\\Framework\\(version)\n")])])]),a("p",[t._v("Version 包含已安装 .NET Framework 可再发行组件的版本号。 例如：")]),t._v(" "),a("div",{staticClass:"language-txt extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("C:\\Windows\\Microsoft.NET\\Framework\\v4.6.1\n")])])]),a("p",[t._v("一旦将 .NET Framework 目录添加到路径后，您可以使用以下命令将该存储过程示例编译到某一程序集中。 "),a("strong",[t._v("/Target")]),t._v("选项可用于将其编译为程序集。")]),t._v(" "),a("p",[t._v("对于 Visual C# 源文件：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$csc")]),t._v(" /target:library helloworld.cs\n")])])]),a("p",[t._v("对于 Visual Basic 源文件：")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$vbc")]),t._v(" /target:library helloworld.vb\n")])])]),a("p",[t._v("以上命令使用 /target 选项启动 Visual C# 或 Visual Basic 编译器，以指定生成库 DLL。")]),t._v(" "),a("p",[t._v("4."),a("code",[t._v("在 SQL Server 中加载并运行“Hello World”存储过程")])]),t._v(" "),a("p",[t._v("一旦该存储过程示例成功编译后，就可以在 SQL Server 中测试它。 为此，打开 SQL Server Management Studio 并创建一个新查询，将其连接到适合的测试数据库（例如，AdventureWorks 示例数据库）。")]),t._v(" "),a("p",[t._v("在 SQL Server 中，能否执行公共语言运行时 (CLR) 代码默认设置为 OFF。 可以通过使用"),a("strong",[t._v("sp_configure")]),t._v("系统存储过程来启用 CLR 代码。 有关详细信息，请参阅 "),a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/clr-integration/clr-integration-enabling?view=sql-server-2017",target:"_blank",rel:"noopener noreferrer"}},[t._v("Enabling CLR Integration"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("p",[t._v("我们将需要创建该程序集，以便可以访问该存储过程。 对于此示例，我们将假定您已在 C:\\ 目录中创建了 helloworld.dll 程序集。 将以下 Transact-SQL 语句添加到您的查询中。")]),t._v(" "),a("div",{staticClass:"language-shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$CREATE")]),t._v(" ASSEMBLY helloworld from "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'c:\\helloworld.dll'")]),t._v(" WITH PERMISSION_SET "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SAFE\n")])])]),a("p",[t._v("一旦创建了该程序集后，我们现在就可以通过使用 create procedure 语句访问 HelloWorld 方法。 我们将存储过程称为“hello”：")]),t._v(" "),a("p",[t._v("SQL 复制")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CREATE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PROCEDURE")]),t._v(" hello\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@i")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" OUTPUT\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("AS")]),t._v("\nEXTERNAL NAME helloworld"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HelloWorldProc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("HelloWorld\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- if the HelloWorldProc class is inside a namespace (called MyNS),")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- the last line in the create procedure statement would be")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("-- EXTERNAL NAME helloworld.[MyNS.HelloWorldProc].HelloWorld")]),t._v("\n")])])]),a("p",[t._v("一旦创建该存储过程后，就可以像用 Transact-SQL 编写的普通存储过程一样运行该存储过程。 运行以下命令：")]),t._v(" "),a("p",[t._v("SQL 复制")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DECLARE")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@J")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("25")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXEC")]),t._v(" hello "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@J")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("out")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("PRINT")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("@J")]),t._v("\n")])])]),a("p",[t._v("这将在 SQL Server Management Studio 消息窗口中导致以下输出。")]),t._v(" "),a("p",[t._v("复制")]),t._v(" "),a("div",{staticClass:"language-txt extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("Hello world!\nHello world!\n")])])]),a("p",[t._v("5."),a("code",[t._v("删除“Hello World”存储过程示例")])]),t._v(" "),a("p",[t._v("在您完成该存储过程示例的运行后，可以从测试数据库中删除该过程和程序集。")]),t._v(" "),a("p",[t._v("首先，使用 drop procedure 命令删除该存储过程。")]),t._v(" "),a("p",[t._v("SQL 复制")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXISTS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" sysobjects "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hello'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("drop")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("procedure")]),t._v(" hello\n")])])]),a("p",[t._v("一旦该存储过程删除后，就可以删除包含示例代码的程序集。")]),t._v(" "),a("p",[t._v("SQL 复制")]),t._v(" "),a("div",{staticClass:"language-sql extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("IF")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXISTS")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" sys"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("assemblies "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'helloworld'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("drop")]),t._v(" assembly helloworld\n")])])]),a("h2",{attrs:{id:"数据导入"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据导入"}},[t._v("#")]),t._v(" 数据导入")]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/import-export/import-data-from-excel-to-sql?view=sql-server-ver15#prerequisite---save-excel-data-as-text",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考链接"),a("OutboundLink")],1)])]),t._v(" "),a("p",[t._v("有几种方式，直接导入"),a("code",[t._v("excel(xls,xlsx,csv)")]),t._v(","),a("code",[t._v("BCP")]),t._v(","),a("code",[t._v("BuilkInsert")]),t._v("。")])])}),[],!1,null,null,null);s.default=n.exports}}]);